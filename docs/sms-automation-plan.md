# 자동화 모듈 계획서

## 개요

n8n 스타일의 블록 기반 자동화 시스템.
점주가 블록을 드래그 & 연결하여 자동화 플로우를 구성한다.

### 자동화 유형
1. **문자 자동화**: "언제 → 누구에게 → 어떤 문자를" 설정하여 자동 발송
2. **포인트 자동화**: "언제 → 누구에게 → 얼마의 포인트를" 설정하여 자동 지급/차감

---

## 핵심 기능

### 1. 블록 기반 자동화 에디터

블록을 드래그 & 연결하여 플로우 구성. 플로우 유형에 따라 액션 블록이 달라진다.

#### 트리거 블록 (언제)
- **시간 지정**: 오전 9시 ~ 오후 9시 범위 내 특정 시각 선택
- **주기 설정**: 매일 / 매주 특정 요일 / 매월 특정일
- **수동 실행**: 주기 없이 저장만 해두고 원할 때 수동 발송 (자주 쓰지만 시기가 불확실한 경우)

#### 대상 블록 (누구에게)
- **세그먼트 필터**: 방문 세그먼트(이탈, 이탈위험, 복귀, 신규, 일반, 단골, VIP)
- **이용권 필터**: 당일권, 시간권, 기간권, 고정석
- **추가 필터**: 연령대, 성별, 방문 횟수, 소비 금액, 세그먼트 경과일
- **커스텀 조건**: 특정 기간 내 미방문 N일 이상 등
- 필터 조합 가능 (AND 조건)

#### 액션 블록 — 메시지 (문자 자동화)
- 점주가 직접 문자 내용 입력
- 변수 삽입 지원: `{이름}`, `{마지막방문일}`, `{방문횟수}` 등
- SMS(90byte) / LMS(2,000byte) 자동 판별
- 미리보기 기능

#### 액션 블록 — 포인트 (포인트 자동화)
- **지급/차감 선택**: 포인트 추가 또는 차감
- **포인트 금액 설정**: 고정 금액 (예: 1,000P) 또는 비율 기반 (예: 최근 결제의 5%)
- **지급 사유 입력**: 로그에 기록될 사유 (예: "이탈위험 복귀 보너스", "VIP 감사 포인트")
- **변수 삽입 지원**: `{이름}`, `{방문횟수}` 등을 사유 메시지에 활용
- **포인트 유효기간**: 지급일로부터 N일 (기본 30일, 변경 가능)
- **중복 지급 방지**: 동일 플로우에서 동일 고객에게 N일 내 재지급 방지 옵션
- 미리보기: 예상 대상 인원 × 포인트 금액 = 총 지급 예상액

### 2. 자동화 그룹 (여러 페이지)

- 여러 자동화 플로우를 각각 별도 페이지로 관리
- 예시 (문자 자동화):
  - "이탈위험 고객 리마인드" → 매일 10시, 이탈위험 14일+, 재방문 유도 문자
  - "신규 환영 문자" → 매일 18시, 신규 고객, 환영 메시지
  - "VIP 감사 문자" → 수동 발송, VIP 고객, 감사 메시지
- 예시 (포인트 자동화):
  - "이탈위험 복귀 보너스" → 매일 10시, 이탈위험 세그먼트, 1,000P 지급
  - "신규 가입 웰컴 포인트" → 매일 18시, 신규 고객, 2,000P 지급
  - "VIP 월간 보너스" → 매월 1일, VIP 고객, 3,000P 지급
  - "장기 미방문 포인트 만료" → 매주 월요일, 60일+ 미방문, 미사용 포인트 차감
- 각 플로우 활성/비활성 토글
- 마지막 실행 시각, 발송 건수 표시

### 3. 포인트 관리

#### 잔여 포인트 표시
- 문자 시스템의 잔여 포인트를 크롤링하여 실시간 표시
- 자동화 메인 페이지 상단에 표시

#### 발송 비용 예측
- 메시지 byte 수 × 대상 인원 수로 예상 포인트 소모량 계산
- SMS: ~20원/건, LMS: ~50원/건 (실제 단가 확인 필요)
- 플로우 저장/수정 시 예상 비용 표시

#### 포인트 부족 알림
- 현재 등록된 모든 활성 자동문자의 예상 소모량 합산
- 잔여 포인트가 약 5회 발송분 이하로 떨어지면 알림
- 알림 방식: 대시보드 배너 + (추후) 카카오톡/이메일 알림
- 자동충전 기능은 추후 검토

### 4. 포인트 자동화 상세

#### 포인트 지급 플로우
- 조건에 맞는 대상 고객에게 자동으로 포인트를 지급
- 지급 후 알림 문자 자동 발송 옵션 (문자 블록과 연결 가능)
- 지급 사유와 함께 고객 포인트 이력에 자동 기록

#### 포인트 차감 플로우
- 유효기간 만료, 장기 미방문 등 조건에 따라 포인트 자동 차감
- 차감 전 사전 알림 옵션 (예: 만료 7일 전 문자 발송)
- 차감 사유와 함께 고객 포인트 이력에 자동 기록

#### 복합 플로우 (문자 + 포인트)
- 하나의 플로우에서 문자 블록과 포인트 블록을 함께 연결 가능
- 예: 이탈위험 고객 → 1,000P 지급 → "포인트가 지급되었습니다" 문자 발송
- 순차 실행: 포인트 지급 성공 시에만 문자 발송 (조건부 연결)

#### 포인트 지급 관리
- 포인트는 현금 비용이 들지 않음 (매장 자체 포인트)
- 월간 포인트 지급 한도 설정 가능 (남발 방지 목적)
- 한도 초과 시 플로우 일시정지 + 점주 알림
- 포인트 지급 현황 대시보드: 이번 달 총 지급액, 차감액, 순 변동

### 5. 비용 리포트

- 자동화 메인 페이지에 이번 달 비용 요약
- **문자 비용**: 발송 건수, 소모 포인트, SMS/LMS 비율
- **포인트 지급 현황**: 지급 건수, 총 지급 포인트, 차감 건수, 순 변동 (현금 비용 없음)
- **통합 요약**: 문자 발송 비용 + 포인트 지급 현황 한눈에
- 일별 추이 차트 (스택 바 차트: 문자 비용 + 포인트 지급액을 날짜별로 표시)
- 날짜별 상세: 해당 날짜의 문자 발송 건수/비용 + 포인트 지급 건수/금액 확인 가능

### 6. 성과 측정 (논의 필요)

자동화 실행 후 효과를 어떻게 측정할지 아직 미확정. 논의할 포인트:

- **복귀율**: 자동화 대상 중 N일 내 재방문한 비율
  - 측정 방법: 실행 시점의 대상 고객 ID 저장 → 이후 방문 데이터와 매칭
  - 비교군: 같은 세그먼트이나 자동화 미적용 고객 (A/B 테스트는 복잡)
- **매출 기여**: 복귀 고객의 실행 후 매출 합산
- **문자 효율**: 건당 복귀율, 건당 매출 기여
- **포인트 효율**: 지급 포인트 대비 복귀율, 포인트 대비 매출 (ROI)
  - 예: 1,000P 지급 → 재방문 시 평균 15,000원 결제 → ROI 15배
- **포인트 사용률**: 지급된 포인트 중 실제 사용된 비율
- 기간: 실행 후 7일/14일/30일 기준 측정

#### 구현에 필요한 것
- `sms_send_log` 테이블: 발송일, 대상 고객ID, 플로우ID, 메시지 내용
- `point_action_log` 테이블: 지급/차감일, 대상 고객ID, 플로우ID, 금액, 사유
- 실행 후 방문 데이터와 조인하여 복귀 여부 판별
- 성과 대시보드: 플로우별 복귀율, 매출 기여, 포인트 ROI 등

---

## 기술 구현

### 인프라

| 구성요소 | 기술 | 비고 |
|---------|------|------|
| 자동화 실행 | GitHub Actions Cron | 매시간 (09~21시 KST), public 레포 무제한 무료 |
| 자동화 설정 저장 | Neon PostgreSQL | 기존 DB에 테이블 추가 |
| 에디터 UI | React Flow (reactflow.dev) | 노드 기반 에디터 라이브러리 |
| 프론트엔드 | Next.js (현재 플랫폼) | `/automation` 경로 |
| 문자 발송 | 기존 문자 시스템 API | 크롤러에서 정보 전달 |
| 포인트 지급 | 기존 포인트 시스템 API | 크롤러에서 정보 전달 |

### DB 스키마 (초안)

```
automation_flows (자동화 플로우 — 문자/포인트 공용)
├── id
├── name (플로우 이름)
├── flowType (SMS / POINT / SMS_POINT)
├── branchId (지점)
├── isActive (활성 여부)
├── triggerConfig (JSON: 시간, 주기 설정)
├── filterConfig (JSON: 대상 필터 조건)
├── messageTemplate (문자 내용 템플릿, flowType에 SMS 포함 시)
├── messageType (SMS/LMS, flowType에 SMS 포함 시)
├── pointConfig (JSON: 포인트 설정, flowType에 POINT 포함 시)
│   ├── action: "GRANT" | "DEDUCT"
│   ├── amount: number (고정 금액)
│   ├── reason: string (지급/차감 사유)
│   ├── expiryDays: number (유효기간, 기본 30일)
│   └── deduplicateDays: number | null (중복 방지 기간)
├── createdBy
├── createdAt / updatedAt
└── lastExecutedAt

sms_send_log (문자 발송 기록)
├── id
├── flowId
├── customerId
├── phone
├── message
├── byteCount
├── pointUsed
├── sentAt
└── status (SUCCESS/FAILED)

point_action_log (포인트 지급/차감 기록)
├── id
├── flowId
├── customerId
├── phone
├── action (GRANT/DEDUCT)
├── amount (포인트 금액)
├── reason (사유)
├── expiryDate (만료일, 지급 시)
├── executedAt
└── status (SUCCESS/FAILED)

sms_point_history (문자 시스템 포인트 이력)
├── id
├── branchId
├── balance (잔여 포인트)
├── checkedAt (크롤링 시점)
```

### 실행 흐름

```
GitHub Actions Cron (매시간)
  ↓
1. DB에서 현재 시각에 실행할 활성 플로우 조회
  ↓
2. 각 플로우의 필터 조건으로 대상 고객 조회
  ↓
3. 플로우 타입에 따라 분기:
  ├── [SMS] 메시지 템플릿 변수 치환 → 문자 API 호출 → sms_send_log 저장
  ├── [POINT] 포인트 지급/차감 API 호출 → point_action_log 저장
  └── [SMS_POINT] 포인트 처리 → 성공 시 문자 발송 → 양쪽 로그 저장
  ↓
4. 문자 시스템 포인트 잔액 크롤링 → sms_point_history 저장
  ↓
5. 문자 포인트 부족 시 알림 트리거
  ↓
6. 월간 포인트 지급 한도 초과 체크 → 초과 시 알림
```

### 프론트엔드 구조

```
src/
├── app/
│   ├── automation/                  # 자동화 메인 (비용 요약, 플로우 목록)
│   │   ├── page.tsx
│   │   └── [flowId]/               # 플로우 편집 (블록 에디터)
│   │       └── page.tsx
│   └── api/
│       └── automation/
│           ├── flows/              # 플로우 CRUD
│           ├── send-log/           # 발송 기록 조회
│           ├── points/             # 포인트 조회
│           └── execute/            # 수동 실행
├── components/
│   └── automation/
│       ├── FlowEditor/            # React Flow 기반 에디터
│       ├── TriggerBlock/          # 트리거 블록 설정 UI
│       ├── FilterBlock/           # 대상 필터 블록 설정 UI
│       ├── MessageBlock/          # 메시지 액션 블록 UI (문자)
│       ├── PointBlock/            # 포인트 액션 블록 UI (지급/차감)
│       ├── FlowList/              # 플로우 목록 (문자/포인트 타입 구분)
│       ├── PointStatus/           # 문자 시스템 포인트 현황
│       ├── PointActionReport/     # 고객 포인트 지급/차감 현황
│       └── CostReport/            # 통합 비용 리포트
└── types/
    └── automation.ts
```

---

## 구현 순서 (우선순위)

### Phase 1: 기본 문자 자동화
1. DB 스키마 설계 및 마이그레이션 (automation_flows, sms_send_log, point_action_log)
2. 플로우 CRUD API (문자/포인트 타입 공용)
3. 플로우 목록/관리 페이지
4. 블록 에디터 (React Flow) - 트리거/필터/메시지 블록
5. 수동 실행 기능 (문자)
6. GitHub Actions 크론 연동

### Phase 2: 포인트 자동화
7. 포인트 액션 블록 UI (지급/차감 설정)
8. 포인트 지급/차감 API 연동
9. 복합 플로우 지원 (문자 + 포인트)
10. 중복 지급 방지 로직
11. 월간 지급 한도 관리

### Phase 3: 포인트 관리 & 비용 리포트
12. 문자 시스템 포인트 잔액 크롤링
13. 발송 비용 예측
14. 문자 포인트 부족 알림
15. 통합 비용 리포트 (문자 비용 + 포인트 지급 현황, 날짜별 차트)

### Phase 4: 성과 측정
16. 실행 로그 기반 복귀율 계산
17. 포인트 사용률 / ROI 측정
18. 성과 대시보드
19. 플로우별 효과 비교

---

## 미확정 사항

- [ ] 문자 시스템 API 스펙 확인 (엔드포인트, 인증 방식, 요청 형식)
- [ ] 포인트 시스템 API 스펙 확인 (지급/차감 엔드포인트, 잔액 조회)
- [ ] 문자 시스템 포인트 크롤링 방법 (API 제공 여부, 웹 크롤링 필요 여부)
- [ ] SMS/LMS 단가 확인
- [ ] 고객 포인트 유효기간 정책 확정
- [ ] 포인트 차감 시 고객 알림 방식 (사전 알림 필요 여부)
- [ ] 성과 측정 방법론 구체화 (문자 vs 포인트 효과 분리 측정)
- [ ] 자동충전 구현 여부 및 방법
- [ ] 알림 채널 (대시보드 배너 외 카카오톡/이메일 등)
